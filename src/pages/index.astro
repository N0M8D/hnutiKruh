---
export const prerender = false; // dynamické načtení kalendáře
import { parse, isBefore } from 'date-fns';
import Layout from '../layouts/Page.astro';
import { TextSection, Button, Container, AnnouncementBar, BlogPostsList } from '@components/odyssey-theme';
import EventsList from '../components/sections/EventList.astro';
import Lide from '../components/sections/Lide.astro';
import { Icon } from 'astro-icon/components';
import AnimatedCircle from '../components/animated/AnimatedCircle.astro';
import NewsletterForm from '@components/forms/NewsletterForm.astro';
import ComingSoon from '../components/animated/ComingSoon.astro';
import { fetchCalendarEventsNextDays } from '../lib/calendar';

const seo = {
  title: 'Hnutí Kruh',
  description: 'Hnutí Kruh – otevřenost, soudržnost a spolupráce pro férovou politiku',
};

// events nyní z následujících 30 dní
const events = await fetchCalendarEventsNextDays(30);

const peopleModules = import.meta.glob('../pages/people/people-list/*.mdx', { eager: true });

const people = Object.values(peopleModules).map((mod: any) => ({
  name: mod.frontmatter.name,
  description: mod.frontmatter.description,
  photo: mod.frontmatter.featuredImage,
  href: mod.url,
  role: mod.frontmatter.role
}));

// Načteme tři poslední články z blogu
const postModules = import.meta.glob('../pages/blog/posts/*.mdx', { eager: true });

const posts = Object.values(postModules)
  .map((mod: any) => ({
    title: mod.frontmatter.title,
    description: mod.frontmatter.description,
    authors: mod.frontmatter.authors,
    publishDate: parse(mod.frontmatter.publishDate, 'dd.MM.yyyy', new Date()),
    featuredImage: mod.frontmatter.featuredImage,
    excerpt: mod.frontmatter.excerpt,
    href: mod.url
  }))
  .sort((a, b) => {
    if (isBefore(a.publishDate, b.publishDate)) return 1;
    if (isBefore(b.publishDate, a.publishDate)) return -1;
    return 0;
  })
  .slice(0, 3);

---

<Layout {seo}>

  <!-- Banner -->
  <div class="banner">
    <img src="/assets/brand/sukynky_short_transparent.png" alt="banner" class="noShadow" />
  </div> 

  <!-- Poslední články -->
  <div class="clanky">
    <TextSection narrow>
      <h2 id="clanky">Aktuality</h2>
      <BlogPostsList posts={posts} />
      <Button href="./blog" newTab fullWidth>
        Více článků
      </Button>
    </TextSection>
  </div>

  <!-- Akce -->
  <div class="akce">
    <TextSection narrow>
      <h2 id="akce">Kde nás můžete potkat</h2>
      <EventsList events={events} />
      <div class="calendar-link">
        <a
          href="https://calendar.google.com/calendar/embed?src=e3b2ccf24db663a33c6a14b19f6b3691354919608f197b799747719d14f943b9%40group.calendar.google.com&ctz=Europe%2FPrague"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Otevřít celý kalendář v novém okně"
          title="Otevřít celý kalendář"
        >
          <Icon name="mdi:open-in-new" width="18" height="18" />
          <span>Otevřít kalendář</span>
        </a>
      </div>
    </TextSection>
  </div>


  <!-- Lidé -->
  <div class="lide-div">
    <TextSection narrow>
      <h2 id="lide">Naše tváře</h2>
      <Lide people={people.slice(0, 6)} /> <!-- Zobrazí pouze prvních 6 osob -->
      <Button href="/people" fullWidth>
        Další tváře
      </Button>
    </TextSection>
  </div>

  <NewsletterForm/>
</Layout>

<style>
  .banner {
    text-align: center;
  }
  .banner img {
    max-width: 100%;
    height: auto;
  }

  .petice {
    position: relative;
    margin: 2rem 0;
    z-index: 1;
  }
  .petice a {
    color: var(--theme-primary, #333);
    text-decoration: none;
    font-weight: 600;
  }

  .petice-adresy {
    margin-top: 1rem;
    padding-left: 1.5rem;
    list-style-type: disc;
    color: #444;
  }

  .petice-adresy li {
    margin-bottom: 0.75rem;
  }

  .akce {
    margin: 2rem 0;
    position: relative;
    margin: 2rem 0;
    z-index: 1;
  }
  .akce ul {
    list-style: disc;
    padding-left: 2rem;
  }
  .akce li {
    margin-bottom: 0.5rem;
  }

  .lide-div {
    margin: 2rem 0;
  }

  .petition-counter-container {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 0.5rem;
    margin: 1.2rem 0 1.8rem 0;
    font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
  }

  .petition-counter-label {
    font-size: 1.1rem;
    color: #7a4a1b;
    font-weight: 500;
    letter-spacing: 0.02em;
  }

  .petition-counter {
    font-size: 2.6rem;
    font-weight: 700;
    color: #a05a2c;
    text-shadow: 0 2px 18px rgba(139,69,19,0.13), 0 1px 0 #fff;
    margin: 0 0.2rem;
    transition: color 0.3s;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.04em;
    line-height: 1;
    filter: drop-shadow(0 0 8px #ffe6d5aa);
  }

  .petition-counter-goal {
    font-size: 1.1rem;
    color: #bfa07a;
    font-weight: 400;
    margin-left: 0.2rem;
  }

  .calendar-link {
    display: flex;
    justify-content: flex-end; /* zarovnat do rohu (vpravo) */
    margin-top: .5rem;
  }
  .calendar-link a {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    font-size: .8rem;        /* menší text */
    opacity: .7;
    color: inherit;
    text-decoration: none;
    transition: opacity .15s ease, text-decoration-color .15s ease;
  }
  .calendar-link a:hover,
  .calendar-link a:focus-visible {
    opacity: 1;
    text-decoration: underline;
    outline: none;
  }
</style>

<script type="text/javascript" is:inline>
  // Nastavte zde aktuální počet podpisů
  const targetCount = 953; // Změňte dle aktuálního stavu

  let hasAnimated = false;

  function animateCounter() {
    const counter = document.getElementById('petition-counter');
    if (!counter) return;
    let current = 0;
    const duration = 15000;
    const frameRate = 30;
    const totalFrames = Math.round(duration / (1000 / frameRate));
    let frame = 0;

    const animate = () => {
      frame++;
      const progress = Math.min(frame / totalFrames, 1);
      const value = Math.floor(progress * targetCount);
      counter.textContent = value.toLocaleString('cs-CZ');
      if (progress < 1) {
        requestAnimationFrame(animate);
      } else {
        counter.textContent = targetCount.toLocaleString('cs-CZ');
      }
    };
    animate();
  }

  // Spustí animaci při zobrazení sekce Petice
  function onScroll() {
    if (hasAnimated) return;
    const section = document.getElementById('petice');
    if (!section) return;
    const rect = section.getBoundingClientRect();
    if (rect.top < window.innerHeight && rect.bottom > 0) {
      hasAnimated = true;
      animateCounter();
      window.removeEventListener('scroll', onScroll);
    }
  }

  window.addEventListener('scroll', onScroll);
  window.addEventListener('DOMContentLoaded', onScroll);
</script>